# 不得不说的性能优化

## 前言
在我们日常的工作中，我们总是只关注项目能不能按时上线，功能是否受到缩减，很少关注性能优化的事。但是，随着互联网的飞速发展，web应用变得越来越大，功能越来越丰富，需要优化处理的内容也越来越多。所以，本节我们来聊一聊前端优化的知识，由于性能优化涉及到很多领域，知识会呈现出一定的碎片化，希望各位同学做好准备。


## 图片优化
在我们日常的开发中，我相信，基本上大多数项目都会用到图片来使自己的网站更美观或这数据更直白。但是，在飞速发展的现代计算机图形学下，图片的大小越来越大，这使得我们加载图片资源的时间越来越长，所以我们先来聊聊图片优化的内容。

### 计算图片大小

对于一张100*100像素的图片来说，一共又10000个像素点，如果每个像素点是用`RGBA`存储的话，那么也就是说每个像素点有4个通道，每个通道1个字节，所以该图片大小约为39kb(`10000*1*4/1024`).

但是在实际项目中，一张图片并不需要那么多的色彩去显示，我们可以通过减少每个像素的调色板来相应缩小图片的大小。在了解了图片大小的知识后，相信各位对与如何缩小图片大小已经有思路了。`减少像素点`和`减少每个像素点能够现实的颜色`绝对是可以试一试的方法。

### 图片加载优化
对于图片加载优化，相信各位同学有过自己的一些做法，我这边说一些常见的做法，供大家参考一番。
1. 不用图片，我们在很多场景会用到修饰图片，但是这类修饰图片并非只有图片才能做到，我们可以通过使用CSS去代替
2. 对于移动端应用来说，屏幕宽度就那么点，完全没有必要加载原图浪费带宽，一般的图我们可以使用CDN加载，可以计算出屏幕的宽度，然后去请求相应裁剪好的图片
3. 对于一些很小的图，我们可以使用base64格式，或者使用CSS sprites。
4. 选择正确的图片格式。(对于能够显示webP格式的浏览器尽量使用WebP格式，因为WebP格式具有更好的图像数据压缩算法，能带来更小的图片体积，而且拥有肉眼识别无差异的图像质量，缺点就是兼容性较差;小图使用PNG格式，对于图标类的图片，可以使用SVG实现;照片使用JPEG)

## DNS预解析

在我们的日常请求中，DNS解析也是需要时间的，可以通过预解析的方式来预先获得域名对应的IP
```html
<link rel='dns-prefetch' href='****.cn'></link>
```

## 预加载

在我们的开发中，可能会遇到这样的情况，有的资源我不需要马上使用，但是我希望尽早获取，这时候就可以使用预加载。

预加载其实就是声明式的`fetch`，强制浏览器去请求资源，并且不会阻塞`onload`事件。开启预加载的方式如下
```html
<link rel="preload" href="http://example.com">
```
预加载可以一定程度上降低首屏的加载时间，因为可以将一些不影响首屏但重要的文件延后加载，唯一缺点就是兼容性不好。

## 预渲染

可以通过预渲染将下载的文件预先在后台渲染，可以使用以下代码开启预渲染
```html
<link rel="prerender" href="http://example.com"> 
```
预渲染虽然可以提高页面的加载速度，但是要确保该页面大概率会被用户在之后打开，否则就是白白浪费资源去渲染。

## 懒执行

懒执行就是将某些逻辑延迟到使用时再计算。该技术可以用于首屏优化，对于某些耗时逻辑并不需要在首屏就使用的，就可以使用懒执行。懒执行需要唤醒，一般可以通过定时器或者事件的调用来唤醒。

## 懒加载

懒加载就是将不关键的资源延后加载。

懒加载的原理就是只加载自定义区域（通常是可视区域，但也可以是即将进入可视区域）内需要加载的东西。对于图片来说，先设置图片标签的`src`属性为一张占位图，将真实的图片资源放入一个自定义属性(一般是data-src)中，当进入自定义区域时，就将自定义属性替换为`src`属性，这样图片就会去下载资源，实现了图片懒加载。

懒加载不仅可以用于图片，也可以使用在别的资源上。比如进入可视区域才开始播放视频等等。

## CDN

CDN的原理是尽可能的在各个地方分布机房缓存数据，这样即使我们的根服务器远在国外，在国内的用户也可以通过国内的机房迅速加载资源。

因此，我们可以将静态资源尽量使用CDN加载，由于浏览器对于单个域名有并发请求上限，可以考虑使用多个CDN域名。并且对于CDN加载静态资源需要注意CDN域名要与主站不同，否则每次请求都会带上主站的Cookie，平白消耗流量。

# 小结

本节我们碎片化地讲解了一些性能优化的内容，这些内容看似很短，但是在出现性能问题时能简单搞笑的提高性能。各位同学可以尝试在自己的项目中应用一下，体验一下功效。